---
interface Props {
  placeholder: string;
  buttonText: string;
  successMessage: string;
  errorMessage: string;
  alreadyMessage: string;
  lang: string;
}

const { placeholder, buttonText, successMessage, errorMessage, alreadyMessage, lang } = Astro.props;
---

<form id="subscribe-form" class="flex gap-2" data-lang={lang}>
  <input
    type="email"
    name="email"
    placeholder={placeholder}
    class="flex-1 px-4 py-3 bg-zinc-900 border border-zinc-800 rounded-lg text-zinc-100 placeholder-zinc-500 focus:outline-none focus:border-amber-500/50 focus:ring-1 focus:ring-amber-500/50 transition-colors"
    required
  />
  <button
    type="submit"
    class="px-6 py-3 bg-amber-500 hover:bg-amber-400 disabled:bg-amber-500/50 disabled:cursor-not-allowed text-zinc-950 font-semibold rounded-lg transition-colors whitespace-nowrap"
  >
    {buttonText}
  </button>
</form>
<p id="subscribe-status" class="mt-3 text-sm hidden"></p>

<script define:vars={{ successMessage, errorMessage, alreadyMessage }}>
  const form = document.getElementById('subscribe-form');
  const status = document.getElementById('subscribe-status');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const email = formData.get('email');
    const lang = form.dataset.lang || 'en';
    const button = form.querySelector('button');

    button.disabled = true;
    status.className = 'mt-3 text-sm hidden';

    try {
      const response = await fetch('/api/subscribe.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, lang }),
      });

      const data = await response.json();

      if (data.success) {
        status.textContent = data.message === 'already_subscribed' ? alreadyMessage : successMessage;
        status.className = 'mt-3 text-sm text-green-400';
        if (data.message === 'subscribed') {
          form.reset();
        }
      } else {
        throw new Error(data.error);
      }
    } catch (err) {
      status.textContent = errorMessage;
      status.className = 'mt-3 text-sm text-red-400';
    } finally {
      button.disabled = false;
    }
  });
</script>
